#!/bin/sh

# dependencies: dmenu awk yt-dlp

format='none'

rm -rf ~/.cache/format

if [ "$1" == "-F" ];then
  yt-dlp -F $2 
else
  video_url=$(echo | dmenu -i -p "Enter YouTube video URL: ")
	type=$(printf "Video+Audio\nAudio Only" | dmenu -i -p "What are you trying to download?")

  yt-dlp -F $video_url | awk 'NR==4, NR==1000 {print $0}' > ~/.cache/format
  
	if [[ $type == 'Audio Only' ]]; then
		cd ~/Music
		notify-send "Trying to download..." 
		yt-dlp -f 'ba' -x --audio-format mp3 --embed-thumbnail $video_url --ppa "EmbedThumbnail+ffmpeg_o:-c:v mjpeg -vf crop=\"'if(gt(ih,iw),iw,ih)':'if(gt(iw,ih),ih,iw)'\"" --parse-metadata "%(uploader|)s:%(meta_artist)s" --add-metadata --output "%(title)s.%(ext)s"
		notify-send "Download finished"
	else
  	[[ -z $video_url ]] && exit || notify-send "Fetching available qualities..."
		audio=$(cat ~/.cache/format | grep audio | dmenu -i -p "Choose audio quality" -l 10 | awk '{print $1}')
		video=$(cat ~/.cache/format | grep video | dmenu -i -p "Choose video quality" -l 10 | awk '{print $1}')
		[[ -z $video ]] && format=$audio || [[ -z $audio ]] && format="$video" || format="$audio+$video"
		echo "User requested format: $format"
		notify-send "Trying to download..." 
		output=$(yt-dlp -f $format --embed-thumbnail --convert-subs srt --embed-sub --yes-playlist $video_url --throttled-rate 100K -P ~/Videos/)
		[[ $output == *merged\ into\ mkv* ]] && notify-send "Requested formats are incompatible. Merging into MKV..." || continue
		[[ $output == *has\ already\ been\ downloaded* ]] && notify-send "Requested audio/video is already present in your videos directory" || [[ -z $output ]] && notify-send "Download unsuccessful" || notify-send "Download finished"
	fi
fi
