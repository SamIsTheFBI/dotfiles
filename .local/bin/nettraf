#!/bin/sh

[ -z "${TERMINAL}" ] && TERMINAL="st"

notify () {
  notify-send -r 415178 -t 3000 "${n_glyph}" "<span font = 'JetBrainsMono Nerd Font 11'>$1</span>" 2>/dev/null
}

check_internet () {
  var=$(ip route get 8.8.8.8 | awk '{print $1; exit}')
  [ "$var" != '8.8.8.8' ] \
    && internet=0 \
    || internet=1
}

check_network_interface () {
  network_interface=$(ip route get 8.8.8.8 | awk '{print $5; exit}')
  case "${network_interface}" in
    eno* | eth* | enp*)  n_glyph="" ;;
    wlo* | wlan* | wlp*) n_glyph="" ;;
    *)                   n_glyph="泌"
  esac
}

update() {
    sum=0
    for arg; do
        read -r i < "$arg"
        sum=$(( sum + i ))
    done
    cache=${XDG_CACHE_HOME:-$HOME/.cache}/${1##*/}
    [ -f "$cache" ] && read -r old < "$cache" || old=0
    printf %d\\n "$sum" > "$cache"
    printf %d\\n $(( sum - old ))
}

net () {
  rx=$(update /sys/class/net/$network_interface/statistics/rx_bytes)
  tx=$(update /sys/class/net/$network_interface/statistics/tx_bytes)
  [ ${internet} -gt 0 ] && printf "%4sB/s %4sB/s" $(numfmt --to=iec $rx $tx) || echo " Disconnected"
}

name () {
  [ ${internet} -gt 0 ] && echo -e "${n_glyph} $(nmcli -t -f NAME connection show --active)" || echo " Disconnected"
}

sbar_output () {
  echo -e "^B2^^C0^ ${1} ^d^"
}

norm_output () {
  echo -e "${1}"
}

check_internet
check_network_interface

case $BLOCK_BUTTON in
    1) [ ${internet} -gt 0 ] \
      && notify "Connected to $(name)<br>$(ip route get 8.8.8.8 | awk 'NR==1 {print $7}')" \
      || notify " Disconnected" ;;
	3) ${TERMINAL} -e nmtui 2>/dev/null ;;
esac

case "${1}" in
  'sbar')  sbar_output "$(net)" ;;
  'name')  norm_output "$(name)"    ;;
  '' | *)  norm_output "$(net)" ;;
esac
