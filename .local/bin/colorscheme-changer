#!/bin/sh

prompt="dmenu -l 12"
# prompt="rofi -dmenu"

#Check if script is already running 
if [ "$(pgrep -f $0)" != "$$" ]; then
    SCRIPTNAME="$(echo $0 | awk -F '/' '{print $NF}')"
    echo "Another instance of $SCRIPTNAME already exists! Exiting"
    [ "$(command -v notify-send)" != '' ] && notify-send -t 2000 "" "<span font = 'JetBrainsMono Nerd Font 11'>Another instance of $SCRIPTNAME already exists! Exiting</span>"
    exit
fi

[ "$1" != '' ] && theme_name="$1" || continue 

[ -z $theme_name ] && sel=$(printf "Save current colorscheme\nChoose a colorscheme\nDelete a colorscheme" | $prompt -p " ")

if [[ $sel == *Save* ]]; then
	theme_name="$( echo | $prompt -p "Give your colorscheme a name: ")" 
	[[ -z $theme_name ]] && exit

	mkdir -p $HOME/.theme/"$theme_name"/ > /dev/null 2>&1 

	cp $HOME/.Xresources $HOME/.theme/"$theme_name"/Xresources
	cp $HOME/.config/dunst/dunstrc $HOME/.theme/"$theme_name"/
	cp $HOME/.config/jgmenu/jgmenurc $HOME/.config/jgmenu/jgmenu_layoutmenu $HOME/.theme/"$theme_name"/
	cp $HOME/.config/rofi/theme.rasi $HOME/.theme/"$theme_name"/
	cp $HOME/.local/share/wallpaper/bg.jpg $HOME/.theme/"$theme_name"/

	notify-send -t 3000 " Color Scheme" "<span font = 'JetBrainsMono Nerd Font 11'>Current color scheme was saved as $theme_name</span>"

elif [[ $sel == *Choose* || "$theme_name" != '' ]]; then
	[ -z $theme_name ] && theme_name=$(find $HOME/.theme -mindepth 1 -maxdepth 1 -type d | awk -F '/' '{print $NF}' | sort -V | $prompt -p "Choose a colorscheme: ")
	[ -z $theme_name ] && exit
    [ ! -d ~/.theme/"$theme_name" ] && notify-send -t 3000 " Color Scheme" "<span font = 'JetBrainsMono Nerd Font 11'>No such color scheme with the name $theme_name present!</span>" && exit
    
	cp $HOME/.theme/"$theme_name"/dunstrc $HOME/.config/dunst/dunstrc
	cp $HOME/.theme/"$theme_name"/jgmenurc $HOME/.config/jgmenu/jgmenurc
	cp $HOME/.theme/"$theme_name"/jgmenu_layoutmenu $HOME/.config/jgmenu/jgmenu_layoutmenu
	cp $HOME/.theme/"$theme_name"/theme.rasi $HOME/.config/rofi/theme.rasi
	cp $HOME/.theme/"$theme_name"/Xresources $HOME/.Xresources
	
	~/.local/bin/setbg $HOME/.theme/"$theme_name"/bg.jpg
	~/.local/bin/setlockbg $HOME/.theme/"$theme_name"/bg.jpg
	
	xrdb -load $HOME/.Xresources
	
	# Reloading dwm to apply changes
	sleep 0.2
	# xdotool key super+control+F5 #xrdb reload
    xsetroot -name "fsignal:1"

	# Reloading dunst notification daemon to apply changes
	pkill dunst
	dunst >/dev/null 2>&1 < /dev/null & 
	
	# Reloading suckless terminal to apply changes
	sleep 0.2
	pidof st | xargs kill -s USR1

	# xdotool key control+F5 #dwm reload

	notify-send -t 3000 " Color Scheme" "<span font = 'JetBrainsMono Nerd Font 11'>Color scheme set to "$theme_name"</span>"
elif [[ $sel == *Delete* ]]; then
	theme_name=$(find $HOME/.theme -mindepth 1 -maxdepth 1 -type d | awk -F '/' '{print $NF}' | sort -V | $prompt -p "Choose a colorscheme: ")
	[[ -z $theme_name ]] && exit

	rm -rf $HOME/.theme/"$theme_name"

	notify-send -t 3000 " Color Scheme" "<span font = 'JetBrainsMono Nerd Font 11'>Deleted "$theme_name" color scheme</span>"
else
	exit
fi
