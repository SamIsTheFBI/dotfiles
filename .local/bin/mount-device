#!/bin/sh

net_connect="$(ip route get 8.8.8.8 | awk 'NR==1 {print $7}')"
[ -z "${net_connect}" ] && internet='NO'

prompt='dmenu -i -h 30 -y 5 -p'
promptl='dmenu -i -h 30 -y 5 -l 12 -p'
cloud_dirs="${HOME}/Cloud Storage"

rclone_mount () {
  [ "${internet}" == 'NO' ] && \
    notify-send -r 134567 -t 2000 "" "<span font = 'JetBrainsMono Nerd Font 11'>No internet connection.</span>" && exit
  
  rclone_remote="$( rclone listremotes | ${prompt} "Choose remote drive: ")"
  [ -z "${rclone_remote}" ] && exit

  mount_point="$(mount | grep "${rclone_remote}" | awk -F 'type' '{print $1}' | awk -F 'on ' '{print $NF}' )"
  [ ! -z "$( mount | grep "${rclone_remote}" )" ] && \
    notify-send -r 134567 "" "<span font = 'JetBrainsMono Nerd Font 11'>Remote location already mounted at ${mount_point}</span>" && exit
  
  mount_point="$( find "${cloud_dirs}" -maxdepth 1 -mindepth 1 -type d | ${promptl} "Choose mount point")"
  [ -z "${mount_point}" ] && exit
  [ ! -e "${mount_point}" ] && mkdir -p -- "${mount_point}"
  [ ! -z "$(mount | grep "${mount_point}")" ] && \
    notify-send -r 134567 -t 2000 "" "<span font = 'JetBrainsMono Nerd Font 11'>Chosen directory is a mounted directory!</span>" && exit
  
  rclone mount "${rclone_remote}" "${mount_point}" &
  notify-send -r 134567 -t 2000 "" "<span font = 'JetBrainsMono Nerd Font 11'>Rclone remote storage mounted successfully</span>"
}

rclone_unmount () {
  mount_point="$( find "${cloud_dirs}" -maxdepth 1 -mindepth 1 -type d | ${promptl} "Choose mount point")"
  [ -z "${mount_point}" ] && exit
  [ -z "$(mount | grep "${mount_point}")" ] && \
    echo EMPTY && \
    notify-send -t 2000 "" "<span font = 'JetBrainsMono Nerd Font 11'>Nothing mounted at \n${mount_point}</span>" && exit
  fusermount -uz "${mount_point}" &
  notify-send -r 134567 -t 2000 "" "<span font = 'JetBrainsMono Nerd Font 11'>Rclone remote storage unmounted successfully</span>"
}


op="$(echo -e "Mount\nUnmount" | ${prompt} "What do you want to do?" )"

mount_type="$(cat <<- EOF | ${prompt} ""
rclone
partition
usb
EOF
)"

case "${mount_type}" in
  rclone) 
    [ "${op}" == 'Mount' ] && rclone_mount && exit;
    [ "${op}" == 'Unmount' ] && rclone_unmount && exit; 
    ;;
  *)      
    exit ;;
esac
